<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:si="http://www.springframework.org/schema/integration"
	xmlns:stream="http://www.springframework.org/schema/integration/stream"
	xmlns:proc="http://yadda.icm.edu.pl/schema/processing"
	xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.springframework.org/schema/context
            http://www.springframework.org/schema/context/spring-context-2.5.xsd
            http://www.springframework.org/schema/integration
            http://www.springframework.org/schema/integration/spring-integration-1.0.xsd
            http://www.springframework.org/schema/integration/stream
            http://www.springframework.org/schema/integration/stream/spring-integration-stream-1.0.xsd
            http://yadda.icm.edu.pl/schema/processing
            http://yadda.icm.edu.pl/schema/processing/yadda-process.xsd">

    <!--
        Bibliographic references extractor training process. It constructs training set from source,
        calculates probabilities, builds a decision tree and stores them for further usage.

        Required process parameters:
        source_dir - directory holding TrueViz resources and extracted citations
    -->

    <import resource="classpath:pl/edu/icm/yadda/analysis/metadata/common/common-beans.xml"/>

    <context:annotation-config/>

    <!-- 1. extract all files from a directory -->
    <proc:source id="someSource" channel="channel1"
        iterator-builder="allFilesFromFolderIteratorBuilder">
    </proc:source>

    <proc:chain id="mainFlow" input-channel="channel1">
        <!-- 2. extract labeled references lines from files -->
        <proc:processor>
            <bean class="pl.edu.icm.yadda.analysis.bibref.extraction.nodes.BibRefLinesFromFilesExtractorNode" />
        </proc:processor>
        <!-- 3. convert references lines to training elements -->
        <proc:processor>
            <bean class="pl.edu.icm.yadda.analysis.bibref.extraction.nodes.BibRefLinesToFVHMMTrainingElementsConverterNode">
            	<property name="featureVectorBuilder" ref="refsExtrFeatureVectorBuilder" />
            </bean>
        </proc:processor>
        <proc:recipient-list-router mutable-input="false">
            <proc:recipient channel="channel2" />
            <proc:recipient channel="channel3" />
            <proc:recipient channel="channel4" />
        </proc:recipient-list-router>
    </proc:chain>

    <!-- 4a. calculate initial probability -->
    <proc:processor input-channel="channel2" output-channel="channel5">
        <bean class="pl.edu.icm.yadda.analysis.classification.hmm.process.nodes.SimpleInitialProbabilityCalculatorNode" />
    </proc:processor>

    <!-- 5a. store initial probability -->
    <proc:writer packageSize="20" channel="channel5">
        <bean class="pl.edu.icm.yadda.analysis.classification.hmm.process.nodes.InitialProbabilityWriterNode">
            <property name="hmmStorage" ref="hmmStorage" />
            <property name="hmmId" value="referenceextraction" />
        </bean>
    </proc:writer>

    <!-- 4b. calculate transition probability -->
    <proc:processor input-channel="channel3" output-channel="channel6">
        <bean class="pl.edu.icm.yadda.analysis.classification.hmm.process.nodes.SimpleTransitionProbabilityCalculatorNode" />
    </proc:processor>

    <!-- 5b. store transition probability -->
    <proc:writer packageSize="20" channel="channel6">
        <bean class="pl.edu.icm.yadda.analysis.classification.hmm.process.nodes.TransitionProbabilityWriterNode">
            <property name="hmmStorage" ref="hmmStorage" />
            <property name="hmmId" value="referenceextraction" />
        </bean>
    </proc:writer>

    <!-- 4c. construct a decision tree -->
    <proc:processor input-channel="channel4" output-channel="channel7">
        <bean class="pl.edu.icm.yadda.analysis.classification.hmm.process.nodes.DecisionTreeEmissionProbabilityCalculatorNode" >
            <property name="featureVectorBuilder" ref="refsExtrFeatureVectorBuilder" />
            <property name="zeroProbabilityValue" value="1.0e-7" />
        </bean>
    </proc:processor>

    <!-- 5c. store decision tree -->
    <proc:writer packageSize="20" channel="channel7">
        <bean class="pl.edu.icm.yadda.analysis.classification.hmm.process.nodes.EmissionProbabilityWriterNode">
            <property name="hmmStorage" ref="hmmStorage" />
            <property name="hmmId" value="referenceextraction" />
        </bean>
    </proc:writer>

    <!-- beans -->
    <bean id="allFilesFromFolderIteratorBuilder"
		class="pl.edu.icm.yadda.analysis.classification.hmm.process.source.AllFilesFromFolderIteratorBuilder" />

    <!-- channels -->

    <si:channel id="channel1">
        <si:queue capacity="200" />
    </si:channel>
    
    <si:channel id="channel2">
        <si:queue capacity="200" />
    </si:channel>

    <si:channel id="channel3">
        <si:queue capacity="200" />
    </si:channel>

    <si:channel id="channel4">
        <si:queue capacity="200" />
    </si:channel>

    <si:channel id="channel5">
        <si:queue capacity="200" />
    </si:channel>

    <si:channel id="channel6">
        <si:queue capacity="200" />
    </si:channel>

    <si:channel id="channel7">
        <si:queue capacity="200" />
    </si:channel>

</beans>